<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="follow.it-verification-code" content="&quot;zhuyYseGcwZBPEeDu2rJ"><title>Beyond the Blueprint</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Beyond the Blueprint"><meta name="msapplication-TileImage" content="/images/theme/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Beyond the Blueprint"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Notes about Software Development and Engineering Managing"><meta property="og:type" content="blog"><meta property="og:title" content="Beyond the Blueprint"><meta property="og:url" content="https://lewandowski.io/"><meta property="og:site_name" content="Beyond the Blueprint"><meta property="og:description" content="Notes about Software Development and Engineering Managing"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://lewandowski.io/img/og_image.png"><meta property="article:author" content="Michał Lewandowski"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://lewandowski.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lewandowski.io"},"headline":"Beyond the Blueprint","image":["https://lewandowski.io/img/og_image.png"],"author":{"@type":"Person","name":"Michał Lewandowski"},"publisher":{"@type":"Organization","name":"Beyond the Blueprint","logo":{"@type":"ImageObject","url":"https://lewandowski.io/images/theme/logo.png"}},"description":"Notes about Software Development and Engineering Managing"}</script><link rel="icon" href="/images/theme/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-46SQQXSRX2" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-46SQQXSRX2');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-1544756215319337" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Beyond the Blueprint" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/theme/logo.png" alt="Beyond the Blueprint" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mlevvy/mlevvy.github.io"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/09/decision-maker/"><img class="fill" src="/images/blog/decision-maker-thumbnail.jpg" alt="Lessons learned from Decision Maker"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2016-09-09T18:00:00.000Z" title="9/9/2016, 8:00:00 PM">2016-09-09</time></span><span class="level-item"><a class="link-muted" href="/categories/Book/">Book</a></span><span class="level-item">5 minutes read (About 719 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/decision-maker/">Lessons learned from Decision Maker</a></p><div class="content"><p>In the past few weeks, I’ve read <a target="_blank" rel="noopener" href="https://www.amazon.com/Getting-Things-Done-Stress-Free-Productivity/dp/0142000280">Getting Things Done</a>, <a target="_blank" rel="noopener" href="http://helion.pl/ksiazki/technical-leadership-od-eksperta-do-lidera-mariusz-sieraczkiewicz,techle.htm">Technical Leadership</a>, <a target="_blank" rel="noopener" href="https://www.amazon.com/Elon-Musk-SpaceX-Fantastic-Future/dp/0062301233/">Elon Musk Biography</a> and <a target="_blank" rel="noopener" href="https://www.amazon.com/Decision-Maker-Potential-Everyone-Organization/dp/0983263329">The Decision Maker</a>. </p>
<p>Each of these books was good. But “The Decision Maker” is a game changer and I can’t stop thinking about this book. It was worth reading - for sure. I’ve decided to write a short book review and note the most important facts that I’ve learned from this book.</p>
<h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>This book is a story about a company and its new owners who have left the corporation and decided to build a great place to work. It is full of dialogues, issues, and situations.</p>
<p>By observing those scenes, the author presents ideas and values that matter when you have to lead the team or the company.</p>
<p>Is this book only for managers or bosses? Certainly not. If you work with other people or deal with non-trivial tasks, this book is for you. For me, it is an appropriate supplement for any “Agile” book.</p>
<p>Blueprint presented in this book is a good starting point for setting up company culture.</p>
<p>The story did not take place in reality. Each scene looks genuine, but as a whole, it seems artificial. Like a romance from 90’s, when you know they will live happily ever after.</p>
<h2 id="People"><a href="#People" class="headerlink" title="People"></a>People</h2><p>To begin with, you have to change your thinking about other people.</p>
<p>People:</p>
<ul>
<li>are unique,</li>
<li>are creative,</li>
<li>are able to learn,</li>
<li>have different strong points,</li>
<li>have different needs,</li>
<li>like a challenge,</li>
<li>are capable of changing the environment,</li>
<li>are capable of making contribution,</li>
<li>can be trusted.</li>
</ul>
<p>Among some people, you can see those values. Among others, you have them hidden, and you have to unlock them. </p>
<p>But there is always somebody who disagrees with it and this is important to remember it. Do you see any similarities with <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Theory_X_and_Theory_Y">Theory X and Y employees</a>?</p>
<h2 id="Decision-Maker"><a href="#Decision-Maker" class="headerlink" title="Decision Maker"></a>Decision Maker</h2><p>Secondly, you have to choose the Decision Maker. It is a person who makes a decision. How to find them? It is simple.</p>
<p>The Decision Maker is a person, who is closest to the action. Bosses or leaders are not often deeply familiar with the situation. Usually, team members are often closer to the problem.</p>
<p>The Decision Maker has to be capable of listening and understanding other people. Making a decision is a process, in which you have to talk and listen to the others.</p>
<p>The Decision Maker should be aware of what is going on. Awareness of facts and consequences is crucial. If the person does not have basic data for making decisions - like company current finance status - you are responsible for unlocking that data.</p>
<p>Wisdom and knowledge are desirable qualities of that person.</p>
<p>It is a leader’s job to choose the Decision Maker. The leader should also observe and monitor the Decision Maker to see if he makes good decisions. If not, something should be done by the leader. </p>
<h2 id="Results-of-making-decision"><a href="#Results-of-making-decision" class="headerlink" title="Results of making decision"></a>Results of making decision</h2><p>It turns out that your employees’ decisions are often as good as or even better than yours can ever be. </p>
<p>People who are allowed to make the decision feel the ownership, because of that they will do everything to make the best possible decision.</p>
<h2 id="Advisory-process"><a href="#Advisory-process" class="headerlink" title="Advisory process"></a>Advisory process</h2><p>The purpose of the advisory process is to look for a wider perspective.<br>The Decision Maker should ask at least a few people what they think about the decision.<br>He or she should ask:</p>
<ul>
<li>team members,</li>
<li>other people with experience,</li>
<li>subordinates and superiors,</li>
<li>anyone who can help.</li>
</ul>
<p>But the Decision Maker should take the final call.</p>
<h2 id="Silver-bullet"><a href="#Silver-bullet" class="headerlink" title="Silver bullet"></a>Silver bullet</h2><p>The decision maker process is not a silver bullet. It is only one tool or technique. The bigger picture is not straightforwardly  visible in the book. </p>
<p>Between the lines, you can see many behaviours and dialogues which look familiar in “Teal Organizations”. If your organization is not ready, the decision maker process is definitely not the road to follow.</p>
<p>Photo credits:<br><a target="_blank" rel="noopener" href="http://www.flickr.com/photos/94075184@N00/28649873046">Banner</a><br><a target="_blank" rel="noopener" href="http://www.flickr.com/photos/95935106@N00/8152320111">Thumbnail</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/02/formatting-java-time-with-spring-boot-using-json/"><img class="fill" src="/images/blog/stf1-thumbnail.jpg" alt="Formatting Java Time with Spring Boot using JSON"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2016-02-03T19:00:00.000Z" title="2/3/2016, 8:00:00 PM">2016-02-03</time></span><span class="level-item"><a class="link-muted" href="/categories/Software-Development/">Software Development</a></span><span class="level-item">7 minutes read (About 1034 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/02/formatting-java-time-with-spring-boot-using-json/">Formatting Java Time with Spring Boot using JSON</a></p><div class="content"><p><strong>The aim of this post is to summarize and review ways of formatting Java Time objects using Spring Boot and Jackson library.</strong></p>
<p>This post is organized in five steps. Each step represents one aspect of the issue and it is also related to one commit in example project repository.</p>
<h2 id="Step-0-Prerequirements"><a href="#Step-0-Prerequirements" class="headerlink" title="Step 0 - Prerequirements"></a>Step 0 - Prerequirements</h2><h3 id="Versions-and-dependencies"><a href="#Versions-and-dependencies" class="headerlink" title="Versions and dependencies"></a>Versions and dependencies</h3><p>This tutorial is based on <code>Spring Boot</code> version <code>1.3.1.RELEASE</code> with <code>spring-boot-starter-web</code>. It uses <code>jackson-datatype-jsr310</code> from <code>com.fasterxml.jackson.datatype</code> in version <code>2.6.4</code>, which is a default version of <code>Spring Boot</code>. All of these is based on Java 8.</p>
<h3 id="The-Code"><a href="#The-Code" class="headerlink" title="The Code"></a>The Code</h3><p>In the example <a target="_blank" rel="noopener" href="https://github.com/mlevvy/spring-boot-json-dates">code repository</a>, you can find one HTTP service made with <code>Spring Boot</code>. This service is a <code>GET</code> operation, which returns a class with Java Time objects.<br>You can also find the integration test that deserializes the response.</p>
<h2 id="Step-1-The-goal"><a href="#Step-1-The-goal" class="headerlink" title="Step 1 - The goal"></a>Step 1 - The goal</h2><p>I would like to return class <code>Clock</code>, containing <code>LocalDate</code>,<code>LocalTime</code> and <code>LocalDateTime</code>, preinitialized in constructor.</p>
<figure class="highlight java"><figcaption><span>Clock - Service response class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Clock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocalDate localDate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocalTime localTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocalDateTime localDateTime;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Response class is serialized to JSON Map, which is a default behaviour. To some extent it is correct, but ISO formatted Strings in response are preferable.</p>
<figure class="highlight json"><figcaption><span>LocalDate - response as JSON Map</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">   <span class="attr">&quot;localDate&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>  </span><br><span class="line">      <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span><span class="number">2016</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;month&quot;</span><span class="punctuation">:</span><span class="string">&quot;JANUARY&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;era&quot;</span><span class="punctuation">:</span><span class="string">&quot;CE&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dayOfYear&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dayOfWeek&quot;</span><span class="punctuation">:</span><span class="string">&quot;FRIDAY&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;leapYear&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dayOfMonth&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;monthValue&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;chronology&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>  </span><br><span class="line">         <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;ISO&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;calendarType&quot;</span><span class="punctuation">:</span><span class="string">&quot;iso8601&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Integration testing is an appropriate way to test our functionality.</p>
<figure class="highlight java"><figcaption><span>Example of integration test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ResponseEntity&lt;Clock&gt; resp = sut.getForEntity(<span class="string">&quot;http://localhost:8080/clock&quot;</span>, Clock.class);</span><br><span class="line"></span><br><span class="line">assertEquals(OK, resp.getStatusCode());</span><br><span class="line">assertEquals(c.getLocalDate(), resp.getBody().getLocalDate());</span><br><span class="line">assertEquals(c.getLocalTime(), resp.getBody().getLocalTime());</span><br><span class="line">assertEquals(c.getLocalDateTime(), resp.getBody().getLocalDateTime());</span><br></pre></td></tr></table></figure>

<p>Unfortunately, tests are not passing, because of deserialization problems. The exception with message is thrown <code>can not instantiate from JSON object</code>.</p>
<h2 id="Step-2-Adds-serialization"><a href="#Step-2-Adds-serialization" class="headerlink" title="Step 2 - Adds serialization"></a>Step 2 - Adds serialization</h2><p>First things first. We have to add JSR-310 module. It is a datatype module to make <a target="_blank" rel="noopener" href="http://jackson.codehaus.org/">Jackson</a> recognize Java 8 Date &amp; Time API data types.</p>
<p>Note that in this example <code>jackson-datatype-jsr310</code> version is inherited from <code>spring-boot-dependencies</code> dependency management.</p>
<figure class="highlight xml"><figcaption><span>Dependency in pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Response is now consistent but still, not perfect. Dates are serialized as numbers:</p>
<figure class="highlight json"><figcaption><span>Dates serialized to numbers and integers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">   <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDate&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span>  </span><br><span class="line">      <span class="number">2016</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">1</span></span><br><span class="line">   <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localTime&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span>  </span><br><span class="line">      <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">24</span></span><br><span class="line">   <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDateTime&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span>  </span><br><span class="line">      <span class="number">2016</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="number">24</span></span><br><span class="line">   <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;zonedDateTime&quot;</span><span class="punctuation">:</span><span class="number">1451640240.000000000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>We are one step closer to our goal. Tests are passing now because this format can deserialized without any additional deserializers.<br>How do I know?<br>Start an application server on commit <code>Step 2 - Adds Object Mapper</code>, then checkout to <code>Step 1 - Introduce types and problems</code>, and run integration tests without <code>@WebIntegrationTest</code> annotation.</p>
<h2 id="Step-3-Enables-ISO-formatting"><a href="#Step-3-Enables-ISO-formatting" class="headerlink" title="Step 3 - Enables ISO formatting"></a>Step 3 - Enables ISO formatting</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> formatting is a standard. I’ve found it in many projects. We are going to enable and use it.<br>Edit spring boot properties file <code>application.properties</code> and add the following line:</p>
<figure class="highlight bash"><figcaption><span>application.properties file - disabling timestamps write</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.jackson.serialization.WRITE_DATES_AS_TIMESTAMPS = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>Now, the response is something that I’ve expected:</p>
<figure class="highlight json"><figcaption><span>Dates serialized as Strings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">   <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDate&quot;</span><span class="punctuation">:</span><span class="string">&quot;2016-01-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;10:24&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDateTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2016-01-01T10:24&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;zonedDateTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2016-01-01T10:24:00+01:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Step-4-Adds-on-demand-formatting-pattern"><a href="#Step-4-Adds-on-demand-formatting-pattern" class="headerlink" title="Step 4 - Adds on demand formatting pattern"></a>Step 4 - Adds on demand formatting pattern</h2><p>Imagine one of your client systems does not have a capability of formatting time. It may be a primitive device, or microservice that treats this date as a collection of characters. That is why special formatting is required.  </p>
<p>We can change formatting in response class by adding <code>JsonFormat</code> annotation with pattern parameter. Standard <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/6/docs/api/java/text/SimpleDateFormat.html">SimpleDateFormat</a> rules apply.</p>
<figure class="highlight java"><figcaption><span>Using @JsonFormat annotation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;dd::MM::yyyy&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LocalDate localDate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonFormat(pattern = &quot;KK:mm a&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LocalTime localTime;</span><br></pre></td></tr></table></figure>
<p>Below there is a service response using custom <code>@JsonFormat</code> pattern:</p>
<figure class="highlight json"><figcaption><span>Custom response style</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">   <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDate&quot;</span><span class="punctuation">:</span><span class="string">&quot;01::01::2016&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;10:24 AM&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;localDateTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2016-01-01T10:24&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;zonedDateTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2016-01-01T10:24:00+01:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Our tests are still passing. It means that this pattern is used for serialization in service and deserialization in tests.</p>
<h2 id="Step-5-Globally-changes-formatting"><a href="#Step-5-Globally-changes-formatting" class="headerlink" title="Step 5 - Globally changes formatting"></a>Step 5 - Globally changes formatting</h2><p>There are situations where you have to resign from <code>ISO 8601</code> formatting in your whole application, and apply custom made standards. </p>
<p>In this part, we will redefine format pattern for LocalDate. This will change formatting of LocalDate in <strong>every endpoint</strong> of your API.</p>
<p>We have to define:</p>
<ul>
<li><code>DateTimeFormatter</code> with our pattern.</li>
<li><code>Serializer</code> using defined pattern.</li>
<li><code>Deserializer</code> using defined pattern.</li>
<li><code>ObjectMapper</code> bean with custom serializer and deserializer.</li>
<li><code>RestTemplate</code> that uses our <code>ObjectMapper</code>.</li>
</ul>
<p>Bean ObjectMapper is defined with annotation <code>@Primary</code>, to override default configuration.<br>My custom pattern for <code>LocalDate</code> is <code>dd::MM::yyyy</code></p>
<figure class="highlight java"><figcaption><span>Object mapper bean with custom pattern</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DateTimeFormatter</span> <span class="variable">FORMATTER</span> <span class="operator">=</span> ofPattern(<span class="string">&quot;dd::MM::yyyy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> ObjectMapper <span class="title function_">serializingObjectMapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">JavaTimeModule</span> <span class="variable">javaTimeModule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaTimeModule</span>();</span><br><span class="line">    javaTimeModule.addSerializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateSerializer</span>());</span><br><span class="line">    javaTimeModule.addDeserializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateDeserializer</span>());</span><br><span class="line">    objectMapper.registerModule(javaTimeModule);</span><br><span class="line">    <span class="keyword">return</span> objectMapper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Definitions of serializer and deserializer for all LocalDate classes:</p>
<figure class="highlight java"><figcaption><span>Custom serializer and deserializer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;LocalDate&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(LocalDate value, JsonGenerator gen, SerializerProvider serializers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        gen.writeString(value.format(FORMATTER));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateDeserializer</span> <span class="keyword">extends</span> <span class="title class_">JsonDeserializer</span>&lt;LocalDate&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalDate <span class="title function_">deserialize</span><span class="params">(JsonParser p, DeserializationContext ctxt)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDate.parse(p.getValueAsString(), FORMATTER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, the response is formatted with our custom pattern:</p>
<figure class="highlight java"><figcaption><span>Formatted response</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="string">&quot;localDate&quot;</span>:<span class="string">&quot;01::01::2016&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tests"><a href="#Tests" class="headerlink" title="Tests"></a>Tests</h3><p>When we define custom serializer, our tests start to fail. It is because RestTemplate knows nothing about our deserializer. We have to create custom RestTemplateFactory that creates RestTemplate with object mapper containing our deserializer.</p>
<figure class="highlight java"><figcaption><span>Custom RestTemplateFactory</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">createRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">jsonConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">        jsonConverter.setObjectMapper(objectMapper);</span><br><span class="line">        converters.add(jsonConverter);</span><br><span class="line">        restTemplate.setMessageConverters(converters);</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Custom formatting Dates is relatively simple, but you have to know how to set up it. Luckily, <code>Jackson</code> works smoothly with <code>Spring</code>. If you know other ways of solving this problem or you have other observations, please comment or let me know.</p>
<p>Photo credits: <a target="_blank" rel="noopener" href="http://www.flickr.com/photos/19511776@N00/286814746">Banner</a>, <a target="_blank" rel="noopener" href="http://www.flickr.com/photos/49968232@N00/2474880917">Thumbnail</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/01/clojure-summary/"><img class="fill" src="/images/blog/brackets-thumbnail.png" alt="Clojure - Fascinated, Disappointed, Astonished"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2016-01-02T11:30:00.000Z" title="1/2/2016, 12:30:00 PM">2016-01-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Software-Development/">Software Development</a></span><span class="level-item">12 minutes read (About 1763 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/01/clojure-summary/">Clojure - Fascinated, Disappointed, Astonished</a></p><div class="content"><p><strong>I’ve had a pleasure to work with <a target="_blank" rel="noopener" href="http://pjagielski.pl/">Piotrek Jagielski</a> for about two weeks on Clojure project. I’ve learned a lot, but there is still a lot to know about Clojure for me. In this post I’ll write what fascinated, disappointed and astonished me about this programming language.</strong></p>
<h5 id="Clojure-InteliJ-IDEA-tips"><a href="#Clojure-InteliJ-IDEA-tips" class="headerlink" title="Clojure &amp; InteliJ IDEA tips"></a>Clojure &amp; InteliJ IDEA tips</h5><p>Before you start your journey with Clojure:</p>
<ul>
<li>Use <a target="_blank" rel="noopener" href="https://cursiveclojure.com/userguide/">Cursive plugin</a> for InteliJ IDEA. In ‘14 Edition it was not in the standard plug-in repository (remove La Clojure plug-in and Cursive repository manually). For IDEA ‘15 it is in repository.</li>
<li>Colored brackets help me a lot. You can find configuration for colored brackets on <a target="_blank" rel="noopener" href="https://github.com/Misophistful/borealis-cursive-theme">Misophistful Github</a>.</li>
</ul>
<h3 id="Fascinated"><a href="#Fascinated" class="headerlink" title="Fascinated"></a>Fascinated</h3><h5 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h5><p>For many people Clojure brackets are reasons to laugh. Jokes like that were funny at first: “How many brackets did you write today?”<br>I have to admit, that at the beginning using brackets was not easy for me. Once I’ve realized that the brackets are just on the other side of the function name, everything was simple and I could code very fast.<br>After few days I’ve realized that this brackets structure forces me to think more about the structure of the code. As a result the code is refactored and divided into small functions.<br>Clojure forces you to use good programming habits.</p>
<h5 id="Data-structure-is-your-code"><a href="#Data-structure-is-your-code" class="headerlink" title="Data structure is your code"></a>Data structure is your code</h5><p>Clojure is <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconic</a>, which means that the Clojure programs are represented by Clojure data structures. This means that when you are reading a Clojure code you see lists, maps, vectors. How cool is that! You only have to know few things and you can code.</p>
<h5 id="Do-not-restart-your-JVM"><a href="#Do-not-restart-your-JVM" class="headerlink" title="Do not restart your JVM"></a>Do not restart your JVM</h5><p>Because Clojure code is represented as data structures, you can pass data structure (program) to running JVM. Furthermore, compiling your code to bytecode (classes, jars) may be eliminated. </p>
<p> For example, when you want to test something you are not obligated to start new JVM with tests. Instead you can just synchronize your working file with running REPL and run the function.</p>
<p> Traditional way of working with JVM is obsolete.</p>
<p><img src="/images/clojure-repl.png" alt="REPL code synchronization"></p>
<p>In the picture above, on the left you can see an editor, on the right there is running REPL.</p>
<p>The same way you can run tests, which is extremely fast. In our project we had ~80 tests. Executing them all took about one second.</p>
<h5 id="Easy-to-read"><a href="#Easy-to-read" class="headerlink" title="Easy to read"></a>Easy to read</h5><blockquote><p>Simplicity is the ultimate sophistication.</p>
<footer><strong>Leonardo da Vinci</strong></footer></blockquote>
<p>After getting familiar with this language, it was really easy to read code. Of course, I was not aware of everything what was happening under the hood, but consistency of the written program evoked sense of control.</p>
<h3 id="Disapointed"><a href="#Disapointed" class="headerlink" title="Disapointed"></a>Disapointed</h3><h5 id="Data-structure-is-your-code-1"><a href="#Data-structure-is-your-code-1" class="headerlink" title="Data structure is your code"></a>Data structure is your code</h5><p>When data structure is your code, you need to have some additional operators to write effective programs. You should get to know operators like ‘-&gt;&gt;’, ‘-&gt;’, ‘let’, ‘letfn’, ‘do’, ‘if’, ‘recur’ …</p>
<p>Even if there is a good documentation (e.g. <a target="_blank" rel="noopener" href="https://clojuredocs.org/clojure.core/let">Let</a>), you have to spend some time on analyzing it, and trying out examples. </p>
<p>As the time goes on, new operators will be developed. But it may lead to multiple Clojure dialects. I can imagine teams (in the same company) using different sets of operators, dealing with the same problems in different ways. It is not good to have too many tools. Nevertheless, this is just my suspicion.</p>
<h5 id="Know-what-you-do"><a href="#Know-what-you-do" class="headerlink" title="Know what you do"></a>Know what you do</h5><p>I’ve written a function that rounds numbers. Despite the fact that this function was simple, I wanted to write test, because I was not sure if I had used the API in correct way. There is the test function below:</p>
<figure class="highlight clojure"><figcaption><span>Rounding test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">let</span></span> [result (<span class="name">fixture/round</span> <span class="number">8.211M</span>)]</span><br><span class="line">  (<span class="name">is</span> (<span class="name"><span class="built_in">=</span></span> <span class="number">8.21M</span> result))))</span><br></pre></td></tr></table></figure>
<p>Unfortunately, tests were not passing. This is the only message that I received:</p>
<figure class="highlight clojure"><figcaption><span>Rounding test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:error-while-loading</span> pl.package.calc-test</span><br><span class="line">NullPointerException   [trace missing]</span><br><span class="line">(<span class="name">pst</span>)</span><br><span class="line">NullPointerException</span><br></pre></td></tr></table></figure>
<p>Great. There is nothing better than a good exception error. I’ve spent a lot of time trying to solve this, and solution was extremely simple.<br>My function was defined with <code>defn-</code>, instead of <code>defn</code>. <code>defn-</code> means private scope and test code, could not access testing function.</p>
<h5 id="Do-not-trust-assertions"><a href="#Do-not-trust-assertions" class="headerlink" title="Do not trust assertions"></a>Do not trust assertions</h5><p>Assertions can be misleading. When tested code does not work properly and returns wrong results, error messages are like this: </p>
<figure class="highlight clojure"><figcaption><span>Assertions problems</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR in math-test/math-operation-test (<span class="name">RT.java:528</span>)</span><br><span class="line">should round using half up</span><br><span class="line">expected: (<span class="name"><span class="built_in">=</span></span> <span class="number">8.31M</span> result)</span><br><span class="line"> actual: java.lang.IllegalArgumentException: Don&#x27;t know how to create ISeq from: java.math.BigDecimal</span><br></pre></td></tr></table></figure>
<p>I hadn’t got time to investigate it, but in my opinion it should work out of the box.</p>
<h5 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h5><p>It is a matter of time, when tools will be better. Those problems will slow you down, and they are not nice to work with.</p>
<h3 id="Astonished"><a href="#Astonished" class="headerlink" title="Astonished"></a>Astonished</h3><p>The Clojure concurrency impressed me. Until then, I knew only standard Java synchronization model and Scala actors model. I’ve never though that concurrency problems can be solved in a different way. I will explain Clojure approach to concurrency, in details.</p>
<h4 id="Normal-variables"><a href="#Normal-variables" class="headerlink" title="Normal variables"></a>Normal variables</h4><p>The closest Clojure’s analogy to the variables are <code>vars</code>, which can be created by <code>def</code>.</p>
<figure class="highlight clojure"><figcaption><span>Vars</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a01</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> <span class="number">10</span>)</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> <span class="number">100</span>)</span><br><span class="line">  (<span class="name">println</span> amount))</span><br></pre></td></tr></table></figure>

<p>We also have local variables which are only in <code>let</code> scope. If we re-define scope value of amount, the change will take place only in local context.</p>
<figure class="highlight clojure"><figcaption><span>Lets</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a02</span> []</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [amount <span class="number">10</span>]</span><br><span class="line">    (<span class="name"><span class="built_in">let</span></span> [amount <span class="number">100</span>]</span><br><span class="line">      (<span class="name">println</span> amount))</span><br><span class="line">    (<span class="name">println</span> amount)))</span><br></pre></td></tr></table></figure>

<p>The following will print:</p>
<figure class="highlight clojure"><figcaption><span>Lets output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>Nothing unusual. We might expect this behavior.</p>
<h3 id="Concurrent-access-variables"><a href="#Concurrent-access-variables" class="headerlink" title="Concurrent access variables"></a>Concurrent access variables</h3><p>The whole idea of concurrent access variables can be written in one sentence. Refs ensures safe shared access to variables via STM, where mutation can only occur via transaction.<br>Let me explain it step by step.</p>
<h5 id="What-is-Refs"><a href="#What-is-Refs" class="headerlink" title="What is Refs?"></a>What is Refs?</h5><p>Refs (reference) is a special type to hold references to your objects. As you can expect, basic things you can do with it is storing and reading values.</p>
<h5 id="What-is-STM"><a href="#What-is-STM" class="headerlink" title="What is STM?"></a>What is STM?</h5><p>STM stands for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Software_transactional_memory">Software Transactional Memory</a>. STM is an alternative to lock-based synchronization system. If you like theory, please continue with Wikipedia, otherwise continue reading to see examples.</p>
<h4 id="Using-Refs"><a href="#Using-Refs" class="headerlink" title="Using Refs"></a>Using Refs</h4><figure class="highlight clojure"><figcaption><span>Refs reads</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a03</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>In the second line, we are creating reference. Name of this reference is <code>amount</code>. Current value is <code>10</code>.<br>In the third line, we are reading value of the reference called <code>amount</code>. Printed result is 10.</p>
<h4 id="Modifying-Refs-without-transaction"><a href="#Modifying-Refs-without-transaction" class="headerlink" title="Modifying Refs without transaction"></a>Modifying Refs without transaction</h4><figure class="highlight clojure"><figcaption><span>Refs writes without transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a04</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name"><span class="built_in">ref-set</span></span> amount <span class="number">100</span>)</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>Using ref-set command, we modify the value of the reference amount to the value 100. But it won’t work. Instead of that we caught exception:</p>
<figure class="highlight clojure"><figcaption><span>Exception</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IllegalStateException No transaction running  clojure.lang.LockingTransaction.getEx (<span class="name">LockingTransaction.java:208</span>)</span><br></pre></td></tr></table></figure>


<h4 id="Using-transaction"><a href="#Using-transaction" class="headerlink" title="Using transaction"></a>Using transaction</h4><figure class="highlight clojure"><figcaption><span>Refs writes with transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a05</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name"><span class="built_in">dosync</span></span> (<span class="name"><span class="built_in">ref-set</span></span> amount <span class="number">100</span>))</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>To modify the code we have to use <code>dosync</code> operation. By using it, we create transaction and only then the referenced value will be changed.</p>
<h4 id="Complete-example"><a href="#Complete-example" class="headerlink" title="Complete example"></a>Complete example</h4><p>The aim of the previous examples was to get familiar with the new operators and basic behavior.<br>Below, I’ve prepared an example to illustrate bolts and nuts of STM, transactions and rollbacks.</p>
<h5 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h5><p>Imagine we have two references for holding data:</p>
<ul>
<li><code>source-vector</code> containing three elements: “A”, “B” and “C”.</li>
<li>empty <code>destination-vector</code>.</li>
</ul>
<p>Our goal is to copy the whole source vector to destination vector. Unfortunately, we can only use function which can copy elements one by one - <code>copy-vector</code>. </p>
<p>Moreover, we have three threads that will do the copy. Threads are started by the <code>future</code> function.</p>
<p>Keep in mind that this is probably not the best way to copy vectors, but it illustrates how STM works.</p>
<figure class="highlight clojure"><figcaption><span>Refs writes with transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">copy-vector</span> [source destination]</span><br><span class="line">  (<span class="name"><span class="built_in">dosync</span></span></span><br><span class="line">    (<span class="name"><span class="built_in">let</span></span> [head (<span class="name"><span class="built_in">take</span></span> <span class="number">1</span> @source)</span><br><span class="line">          tail (<span class="name"><span class="built_in">drop</span></span> <span class="number">1</span> @source)</span><br><span class="line">          conj (<span class="name"><span class="built_in">concat</span></span> head @destination)]</span><br><span class="line">      (<span class="name"><span class="built_in">do</span></span></span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Trying to write destination ... &quot;</span>)</span><br><span class="line">        (<span class="name"><span class="built_in">ref-set</span></span> destination conj)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Trying to write source ... &quot;</span>)</span><br><span class="line">        (<span class="name"><span class="built_in">ref-set</span></span> source tail)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Sucessful write &quot;</span> @destination)))))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">defn</span> <span class="title">a06</span> []</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [source-vector (<span class="name"><span class="built_in">ref</span></span> [<span class="string">&quot;A&quot;</span> <span class="string">&quot;B&quot;</span> <span class="string">&quot;C&quot;</span>]) destination-vector (<span class="name"><span class="built_in">ref</span></span> [])]</span><br><span class="line">    (<span class="name"><span class="built_in">do</span></span></span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name">Thread/sleep</span> <span class="number">500</span>)</span><br><span class="line">      @destination-vector</span><br><span class="line">      )))</span><br></pre></td></tr></table></figure>

<h5 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h5><p>Below is the output of this function. We can clearly see that the result is correct. Destination vector has three elements. Between <code>Sucessful write</code> messages we can see that there are a lot of messages starting with <code>Trying to write</code>.<br>What does it mean? The rollback and retry occurred.</p>
<figure class="highlight plaintext"><figcaption><span>Printed messageslang:Clojure</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(l/a06)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ... </span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write destination ... </span><br><span class="line">Sucessful write (A)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ...</span><br><span class="line">Sucessful write  (B A)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ...</span><br><span class="line">Sucessful write  (C B A)</span><br><span class="line">=&gt; (&quot;C&quot; &quot;B&quot; &quot;A&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="Rollback"><a href="#Rollback" class="headerlink" title="Rollback"></a>Rollback</h5><p>Each thread started to copy this vector, but only one succeed. The remaining two threads had to rollback work and try again one more time.</p>
<p><img src="/images/stm-rollback.png" alt="Software Transaction Memory"></p>
<p>When <code>Thread A</code> (red one) wants to write variable, it notices that the value has been changed by someone else - conflict occurs. As a result, it stops the current work and tries again whole section of <code>dosync</code>. It will try until every write operation succeed.</p>
<h4 id="Pros-and-cons-of-STM"><a href="#Pros-and-cons-of-STM" class="headerlink" title="Pros and cons of STM"></a>Pros and cons of STM</h4><p>Cons:</p>
<ul>
<li>Everything that happens in <code>dosync</code> section has to be pure, without side effects. For example you can not send email to someone, because you might send 10 emails instead of one.  </li>
<li>From performance perspective, it makes sense when you are reading a lot from Refs, but rarely writing it.</li>
</ul>
<p>Pros:</p>
<ul>
<li>Written code is easy to read, understand, modify.</li>
<li>Refs and transactions are part of standard library, so you can use it in Vanilla Java. Take a look at this <a target="_blank" rel="noopener" href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">blog post</a> for more examples.</li>
</ul>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p>There is a lot that Java developers can gain from Clojure. They can learn how to approach the code and how to express the problem in the code. Also they can discover tools like STM.</p>
<p>If you like to develop your skills, you should definitely experiment with Clojure.</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/2/">Previous</a></div><div class="pagination-next"><a href="/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link is-current" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/14/">14</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/theme/logo.png" alt="Michał Lewandowski"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Michał Lewandowski</p><p class="is-size-6 is-block">Engineering Manager</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Europe, Warsaw Poland</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">40</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">44</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://www.linkedin.com/in/lewandowski-io/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mlevvy"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/lewandowski.michal/"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/lewandm4"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://www.linkedin.com/in/lewandowski-io/"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Book/"><span class="level-start"><span class="level-item">Book</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Event/"><span class="level-start"><span class="level-item">Event</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Software-Development/"><span class="level-start"><span class="level-item">Software Development</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Technology/"><span class="level-start"><span class="level-item">Technology</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Agile/"><span class="tag">Agile</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OS-X/"><span class="tag">OS X</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Management/"><span class="tag">Management</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Devoxx/"><span class="tag">Devoxx</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/SCtIS1IzbmIzZjVnTjhYb1p5VDFDajBxWkhVakxja1NkTFNjejYxR1BoMWw0aGloSTMxRThrd0ZRRzFpRFBkQXRqYWVyWko1Y3Q2cExzUkdxMDgvbUxDelhDS0lpK3AyVnllK21MVXRFWC84ZXo5KzYvZUN3bzFoRThrUnZFdnJ8Rm9CT25jaXpobHJZS0NJRXVQdDBPcnJMUE82YlM3MVE1eEhEVk5oOGRCND0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-20T14:48:22.000Z">2023-08-20</time></p><p class="title"><a href="/2023/08/output-vs-outcome/">Outcome vs Output in Software Engineering - A Critical Balance</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-04-03T09:00:00.000Z">2020-04-03</time></p><p class="title"><a href="/2020/04/se-roadmap/">Software Engineer Checklist</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-01-21T19:46:00.000Z">2020-01-21</time></p><p class="title"><a href="/2020/01/best-books-in-2019/">Two best books in 2019</a></p><p class="categories"><a href="/categories/Book/">Book</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-01-25T14:46:00.000Z">2019-01-25</time></p><p class="title"><a href="/2019/01/agile-it-organization-design/">Agile IT Organization Design</a></p><p class="categories"><a href="/categories/Book/">Book</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2017-02-05T16:06:23.000Z">2017-02-05</time></p><p class="title"><a href="/2017/02/thre-levels-of-tdd-1/">Three levels of TDD</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/"><span class="level-start"><span class="level-item">2016</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/"><span class="level-start"><span class="level-item">2015</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/"><span class="level-start"><span class="level-item">2014</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/"><span class="level-start"><span class="level-item">2013</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2012/"><span class="level-start"><span class="level-item">2012</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2011/"><span class="level-start"><span class="level-item">2011</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1544756215319337" data-ad-slot="1495263777" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/theme/logo.png" alt="Beyond the Blueprint" height="28"></a><p class="is-size-7"><span>&copy; 2023 Michał Lewandowski</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>