<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta name="follow.it-verification-code" content="&quot;zhuyYseGcwZBPEeDu2rJ"><title>Tag: Concurrency - Beyond the Blueprint</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Beyond the Blueprint"><meta name="msapplication-TileImage" content="/images/theme/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Beyond the Blueprint"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Notes about Software Development and Engineering Managing"><meta property="og:type" content="blog"><meta property="og:title" content="Beyond the Blueprint"><meta property="og:url" content="https://lewandowski.io/"><meta property="og:site_name" content="Beyond the Blueprint"><meta property="og:description" content="Notes about Software Development and Engineering Managing"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://lewandowski.io/img/og_image.png"><meta property="article:author" content="Michał Lewandowski"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://lewandowski.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lewandowski.io"},"headline":"Beyond the Blueprint","image":["https://lewandowski.io/img/og_image.png"],"author":{"@type":"Person","name":"Michał Lewandowski"},"publisher":{"@type":"Organization","name":"Beyond the Blueprint","logo":{"@type":"ImageObject","url":"https://lewandowski.io/images/theme/logo.png"}},"description":"Notes about Software Development and Engineering Managing"}</script><link rel="icon" href="/images/theme/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-46SQQXSRX2" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-46SQQXSRX2');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-1544756215319337" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Beyond the Blueprint" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/theme/logo.png" alt="Beyond the Blueprint" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/mlevvy/mlevvy.github.io"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Concurrency</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/01/clojure-summary/"><img class="fill" src="/images/blog/brackets-thumbnail.png" alt="Clojure - Fascinated, Disappointed, Astonished"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2016-01-02T11:30:00.000Z" title="1/2/2016, 12:30:00 PM">2016-01-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Software-Development/">Software Development</a></span><span class="level-item">12 minutes read (About 1763 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/01/clojure-summary/">Clojure - Fascinated, Disappointed, Astonished</a></p><div class="content"><p><strong>I’ve had a pleasure to work with <a target="_blank" rel="noopener" href="http://pjagielski.pl/">Piotrek Jagielski</a> for about two weeks on Clojure project. I’ve learned a lot, but there is still a lot to know about Clojure for me. In this post I’ll write what fascinated, disappointed and astonished me about this programming language.</strong></p>
<h5 id="Clojure-InteliJ-IDEA-tips"><a href="#Clojure-InteliJ-IDEA-tips" class="headerlink" title="Clojure &amp; InteliJ IDEA tips"></a>Clojure &amp; InteliJ IDEA tips</h5><p>Before you start your journey with Clojure:</p>
<ul>
<li>Use <a target="_blank" rel="noopener" href="https://cursiveclojure.com/userguide/">Cursive plugin</a> for InteliJ IDEA. In ‘14 Edition it was not in the standard plug-in repository (remove La Clojure plug-in and Cursive repository manually). For IDEA ‘15 it is in repository.</li>
<li>Colored brackets help me a lot. You can find configuration for colored brackets on <a target="_blank" rel="noopener" href="https://github.com/Misophistful/borealis-cursive-theme">Misophistful Github</a>.</li>
</ul>
<h3 id="Fascinated"><a href="#Fascinated" class="headerlink" title="Fascinated"></a>Fascinated</h3><h5 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h5><p>For many people Clojure brackets are reasons to laugh. Jokes like that were funny at first: “How many brackets did you write today?”<br>I have to admit, that at the beginning using brackets was not easy for me. Once I’ve realized that the brackets are just on the other side of the function name, everything was simple and I could code very fast.<br>After few days I’ve realized that this brackets structure forces me to think more about the structure of the code. As a result the code is refactored and divided into small functions.<br>Clojure forces you to use good programming habits.</p>
<h5 id="Data-structure-is-your-code"><a href="#Data-structure-is-your-code" class="headerlink" title="Data structure is your code"></a>Data structure is your code</h5><p>Clojure is <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconic</a>, which means that the Clojure programs are represented by Clojure data structures. This means that when you are reading a Clojure code you see lists, maps, vectors. How cool is that! You only have to know few things and you can code.</p>
<h5 id="Do-not-restart-your-JVM"><a href="#Do-not-restart-your-JVM" class="headerlink" title="Do not restart your JVM"></a>Do not restart your JVM</h5><p>Because Clojure code is represented as data structures, you can pass data structure (program) to running JVM. Furthermore, compiling your code to bytecode (classes, jars) may be eliminated. </p>
<p> For example, when you want to test something you are not obligated to start new JVM with tests. Instead you can just synchronize your working file with running REPL and run the function.</p>
<p> Traditional way of working with JVM is obsolete.</p>
<p><img src="/images/clojure-repl.png" alt="REPL code synchronization"></p>
<p>In the picture above, on the left you can see an editor, on the right there is running REPL.</p>
<p>The same way you can run tests, which is extremely fast. In our project we had ~80 tests. Executing them all took about one second.</p>
<h5 id="Easy-to-read"><a href="#Easy-to-read" class="headerlink" title="Easy to read"></a>Easy to read</h5><blockquote><p>Simplicity is the ultimate sophistication.</p>
<footer><strong>Leonardo da Vinci</strong></footer></blockquote>
<p>After getting familiar with this language, it was really easy to read code. Of course, I was not aware of everything what was happening under the hood, but consistency of the written program evoked sense of control.</p>
<h3 id="Disapointed"><a href="#Disapointed" class="headerlink" title="Disapointed"></a>Disapointed</h3><h5 id="Data-structure-is-your-code-1"><a href="#Data-structure-is-your-code-1" class="headerlink" title="Data structure is your code"></a>Data structure is your code</h5><p>When data structure is your code, you need to have some additional operators to write effective programs. You should get to know operators like ‘-&gt;&gt;’, ‘-&gt;’, ‘let’, ‘letfn’, ‘do’, ‘if’, ‘recur’ …</p>
<p>Even if there is a good documentation (e.g. <a target="_blank" rel="noopener" href="https://clojuredocs.org/clojure.core/let">Let</a>), you have to spend some time on analyzing it, and trying out examples. </p>
<p>As the time goes on, new operators will be developed. But it may lead to multiple Clojure dialects. I can imagine teams (in the same company) using different sets of operators, dealing with the same problems in different ways. It is not good to have too many tools. Nevertheless, this is just my suspicion.</p>
<h5 id="Know-what-you-do"><a href="#Know-what-you-do" class="headerlink" title="Know what you do"></a>Know what you do</h5><p>I’ve written a function that rounds numbers. Despite the fact that this function was simple, I wanted to write test, because I was not sure if I had used the API in correct way. There is the test function below:</p>
<figure class="highlight clojure"><figcaption><span>Rounding test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">let</span></span> [result (<span class="name">fixture/round</span> <span class="number">8.211M</span>)]</span><br><span class="line">  (<span class="name">is</span> (<span class="name"><span class="built_in">=</span></span> <span class="number">8.21M</span> result))))</span><br></pre></td></tr></table></figure>
<p>Unfortunately, tests were not passing. This is the only message that I received:</p>
<figure class="highlight clojure"><figcaption><span>Rounding test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:error-while-loading</span> pl.package.calc-test</span><br><span class="line">NullPointerException   [trace missing]</span><br><span class="line">(<span class="name">pst</span>)</span><br><span class="line">NullPointerException</span><br></pre></td></tr></table></figure>
<p>Great. There is nothing better than a good exception error. I’ve spent a lot of time trying to solve this, and solution was extremely simple.<br>My function was defined with <code>defn-</code>, instead of <code>defn</code>. <code>defn-</code> means private scope and test code, could not access testing function.</p>
<h5 id="Do-not-trust-assertions"><a href="#Do-not-trust-assertions" class="headerlink" title="Do not trust assertions"></a>Do not trust assertions</h5><p>Assertions can be misleading. When tested code does not work properly and returns wrong results, error messages are like this: </p>
<figure class="highlight clojure"><figcaption><span>Assertions problems</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR in math-test/math-operation-test (<span class="name">RT.java:528</span>)</span><br><span class="line">should round using half up</span><br><span class="line">expected: (<span class="name"><span class="built_in">=</span></span> <span class="number">8.31M</span> result)</span><br><span class="line"> actual: java.lang.IllegalArgumentException: Don&#x27;t know how to create ISeq from: java.math.BigDecimal</span><br></pre></td></tr></table></figure>
<p>I hadn’t got time to investigate it, but in my opinion it should work out of the box.</p>
<h5 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h5><p>It is a matter of time, when tools will be better. Those problems will slow you down, and they are not nice to work with.</p>
<h3 id="Astonished"><a href="#Astonished" class="headerlink" title="Astonished"></a>Astonished</h3><p>The Clojure concurrency impressed me. Until then, I knew only standard Java synchronization model and Scala actors model. I’ve never though that concurrency problems can be solved in a different way. I will explain Clojure approach to concurrency, in details.</p>
<h4 id="Normal-variables"><a href="#Normal-variables" class="headerlink" title="Normal variables"></a>Normal variables</h4><p>The closest Clojure’s analogy to the variables are <code>vars</code>, which can be created by <code>def</code>.</p>
<figure class="highlight clojure"><figcaption><span>Vars</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a01</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> <span class="number">10</span>)</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> <span class="number">100</span>)</span><br><span class="line">  (<span class="name">println</span> amount))</span><br></pre></td></tr></table></figure>

<p>We also have local variables which are only in <code>let</code> scope. If we re-define scope value of amount, the change will take place only in local context.</p>
<figure class="highlight clojure"><figcaption><span>Lets</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a02</span> []</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [amount <span class="number">10</span>]</span><br><span class="line">    (<span class="name"><span class="built_in">let</span></span> [amount <span class="number">100</span>]</span><br><span class="line">      (<span class="name">println</span> amount))</span><br><span class="line">    (<span class="name">println</span> amount)))</span><br></pre></td></tr></table></figure>

<p>The following will print:</p>
<figure class="highlight clojure"><figcaption><span>Lets output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>Nothing unusual. We might expect this behavior.</p>
<h3 id="Concurrent-access-variables"><a href="#Concurrent-access-variables" class="headerlink" title="Concurrent access variables"></a>Concurrent access variables</h3><p>The whole idea of concurrent access variables can be written in one sentence. Refs ensures safe shared access to variables via STM, where mutation can only occur via transaction.<br>Let me explain it step by step.</p>
<h5 id="What-is-Refs"><a href="#What-is-Refs" class="headerlink" title="What is Refs?"></a>What is Refs?</h5><p>Refs (reference) is a special type to hold references to your objects. As you can expect, basic things you can do with it is storing and reading values.</p>
<h5 id="What-is-STM"><a href="#What-is-STM" class="headerlink" title="What is STM?"></a>What is STM?</h5><p>STM stands for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Software_transactional_memory">Software Transactional Memory</a>. STM is an alternative to lock-based synchronization system. If you like theory, please continue with Wikipedia, otherwise continue reading to see examples.</p>
<h4 id="Using-Refs"><a href="#Using-Refs" class="headerlink" title="Using Refs"></a>Using Refs</h4><figure class="highlight clojure"><figcaption><span>Refs reads</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a03</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>In the second line, we are creating reference. Name of this reference is <code>amount</code>. Current value is <code>10</code>.<br>In the third line, we are reading value of the reference called <code>amount</code>. Printed result is 10.</p>
<h4 id="Modifying-Refs-without-transaction"><a href="#Modifying-Refs-without-transaction" class="headerlink" title="Modifying Refs without transaction"></a>Modifying Refs without transaction</h4><figure class="highlight clojure"><figcaption><span>Refs writes without transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a04</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name"><span class="built_in">ref-set</span></span> amount <span class="number">100</span>)</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>Using ref-set command, we modify the value of the reference amount to the value 100. But it won’t work. Instead of that we caught exception:</p>
<figure class="highlight clojure"><figcaption><span>Exception</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IllegalStateException No transaction running  clojure.lang.LockingTransaction.getEx (<span class="name">LockingTransaction.java:208</span>)</span><br></pre></td></tr></table></figure>


<h4 id="Using-transaction"><a href="#Using-transaction" class="headerlink" title="Using transaction"></a>Using transaction</h4><figure class="highlight clojure"><figcaption><span>Refs writes with transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">a05</span> []</span><br><span class="line">  (<span class="keyword">def</span> <span class="title">amount</span> (<span class="name"><span class="built_in">ref</span></span> <span class="number">10</span>))</span><br><span class="line">  (<span class="name"><span class="built_in">dosync</span></span> (<span class="name"><span class="built_in">ref-set</span></span> amount <span class="number">100</span>))</span><br><span class="line">  (<span class="name">println</span> @amount))</span><br></pre></td></tr></table></figure>
<p>To modify the code we have to use <code>dosync</code> operation. By using it, we create transaction and only then the referenced value will be changed.</p>
<h4 id="Complete-example"><a href="#Complete-example" class="headerlink" title="Complete example"></a>Complete example</h4><p>The aim of the previous examples was to get familiar with the new operators and basic behavior.<br>Below, I’ve prepared an example to illustrate bolts and nuts of STM, transactions and rollbacks.</p>
<h5 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h5><p>Imagine we have two references for holding data:</p>
<ul>
<li><code>source-vector</code> containing three elements: “A”, “B” and “C”.</li>
<li>empty <code>destination-vector</code>.</li>
</ul>
<p>Our goal is to copy the whole source vector to destination vector. Unfortunately, we can only use function which can copy elements one by one - <code>copy-vector</code>. </p>
<p>Moreover, we have three threads that will do the copy. Threads are started by the <code>future</code> function.</p>
<p>Keep in mind that this is probably not the best way to copy vectors, but it illustrates how STM works.</p>
<figure class="highlight clojure"><figcaption><span>Refs writes with transaction</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">copy-vector</span> [source destination]</span><br><span class="line">  (<span class="name"><span class="built_in">dosync</span></span></span><br><span class="line">    (<span class="name"><span class="built_in">let</span></span> [head (<span class="name"><span class="built_in">take</span></span> <span class="number">1</span> @source)</span><br><span class="line">          tail (<span class="name"><span class="built_in">drop</span></span> <span class="number">1</span> @source)</span><br><span class="line">          conj (<span class="name"><span class="built_in">concat</span></span> head @destination)]</span><br><span class="line">      (<span class="name"><span class="built_in">do</span></span></span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Trying to write destination ... &quot;</span>)</span><br><span class="line">        (<span class="name"><span class="built_in">ref-set</span></span> destination conj)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Trying to write source ... &quot;</span>)</span><br><span class="line">        (<span class="name"><span class="built_in">ref-set</span></span> source tail)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Sucessful write &quot;</span> @destination)))))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">defn</span> <span class="title">a06</span> []</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [source-vector (<span class="name"><span class="built_in">ref</span></span> [<span class="string">&quot;A&quot;</span> <span class="string">&quot;B&quot;</span> <span class="string">&quot;C&quot;</span>]) destination-vector (<span class="name"><span class="built_in">ref</span></span> [])]</span><br><span class="line">    (<span class="name"><span class="built_in">do</span></span></span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name"><span class="built_in">future</span></span> (<span class="name">copy-vector</span> source-vector destination-vector))</span><br><span class="line">      (<span class="name">Thread/sleep</span> <span class="number">500</span>)</span><br><span class="line">      @destination-vector</span><br><span class="line">      )))</span><br></pre></td></tr></table></figure>

<h5 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h5><p>Below is the output of this function. We can clearly see that the result is correct. Destination vector has three elements. Between <code>Sucessful write</code> messages we can see that there are a lot of messages starting with <code>Trying to write</code>.<br>What does it mean? The rollback and retry occurred.</p>
<figure class="highlight plaintext"><figcaption><span>Printed messageslang:Clojure</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(l/a06)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ... </span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write destination ... </span><br><span class="line">Sucessful write (A)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ...</span><br><span class="line">Sucessful write  (B A)</span><br><span class="line">Trying to write destination ...</span><br><span class="line">Trying to write source ...</span><br><span class="line">Sucessful write  (C B A)</span><br><span class="line">=&gt; (&quot;C&quot; &quot;B&quot; &quot;A&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="Rollback"><a href="#Rollback" class="headerlink" title="Rollback"></a>Rollback</h5><p>Each thread started to copy this vector, but only one succeed. The remaining two threads had to rollback work and try again one more time.</p>
<p><img src="/images/stm-rollback.png" alt="Software Transaction Memory"></p>
<p>When <code>Thread A</code> (red one) wants to write variable, it notices that the value has been changed by someone else - conflict occurs. As a result, it stops the current work and tries again whole section of <code>dosync</code>. It will try until every write operation succeed.</p>
<h4 id="Pros-and-cons-of-STM"><a href="#Pros-and-cons-of-STM" class="headerlink" title="Pros and cons of STM"></a>Pros and cons of STM</h4><p>Cons:</p>
<ul>
<li>Everything that happens in <code>dosync</code> section has to be pure, without side effects. For example you can not send email to someone, because you might send 10 emails instead of one.  </li>
<li>From performance perspective, it makes sense when you are reading a lot from Refs, but rarely writing it.</li>
</ul>
<p>Pros:</p>
<ul>
<li>Written code is easy to read, understand, modify.</li>
<li>Refs and transactions are part of standard library, so you can use it in Vanilla Java. Take a look at this <a target="_blank" rel="noopener" href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">blog post</a> for more examples.</li>
</ul>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p>There is a lot that Java developers can gain from Clojure. They can learn how to approach the code and how to express the problem in the code. Also they can discover tools like STM.</p>
<p>If you like to develop your skills, you should definitely experiment with Clojure.</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/theme/logo.png" alt="Michał Lewandowski"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Michał Lewandowski</p><p class="is-size-6 is-block">Engineering Manager</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Europe, Warsaw Poland</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">40</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">44</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://www.linkedin.com/in/lewandowski-io/" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/mlevvy"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://www.facebook.com/lewandowski.michal/"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/lewandm4"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://www.linkedin.com/in/lewandowski-io/"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Book/"><span class="level-start"><span class="level-item">Book</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Event/"><span class="level-start"><span class="level-item">Event</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Software-Development/"><span class="level-start"><span class="level-item">Software Development</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Technology/"><span class="level-start"><span class="level-item">Technology</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Agile/"><span class="tag">Agile</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OS-X/"><span class="tag">OS X</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Management/"><span class="tag">Management</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Devoxx/"><span class="tag">Devoxx</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/SCtIS1IzbmIzZjVnTjhYb1p5VDFDajBxWkhVakxja1NkTFNjejYxR1BoMWw0aGloSTMxRThrd0ZRRzFpRFBkQXRqYWVyWko1Y3Q2cExzUkdxMDgvbUxDelhDS0lpK3AyVnllK21MVXRFWC84ZXo5KzYvZUN3bzFoRThrUnZFdnJ8Rm9CT25jaXpobHJZS0NJRXVQdDBPcnJMUE82YlM3MVE1eEhEVk5oOGRCND0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-20T14:48:22.000Z">2023-08-20</time></p><p class="title"><a href="/2023/08/output-vs-outcome/">Outcome vs Output in Software Engineering - A Critical Balance</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-04-03T09:00:00.000Z">2020-04-03</time></p><p class="title"><a href="/2020/04/se-roadmap/">Software Engineer Checklist</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-01-21T19:46:00.000Z">2020-01-21</time></p><p class="title"><a href="/2020/01/best-books-in-2019/">Two best books in 2019</a></p><p class="categories"><a href="/categories/Book/">Book</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-01-25T14:46:00.000Z">2019-01-25</time></p><p class="title"><a href="/2019/01/agile-it-organization-design/">Agile IT Organization Design</a></p><p class="categories"><a href="/categories/Book/">Book</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2017-02-05T16:06:23.000Z">2017-02-05</time></p><p class="title"><a href="/2017/02/thre-levels-of-tdd-1/">Three levels of TDD</a></p><p class="categories"><a href="/categories/Software-Development/">Software Development</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/"><span class="level-start"><span class="level-item">2016</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/"><span class="level-start"><span class="level-item">2015</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/"><span class="level-start"><span class="level-item">2014</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/"><span class="level-start"><span class="level-item">2013</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2012/"><span class="level-start"><span class="level-item">2012</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2011/"><span class="level-start"><span class="level-item">2011</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1544756215319337" data-ad-slot="1495263777" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/theme/logo.png" alt="Beyond the Blueprint" height="28"></a><p class="is-size-7"><span>&copy; 2023 Michał Lewandowski</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>